#include <LiquidCrystal.h>
#include <SoftwareSerial.h>

// ---------------- LCD and Sensor Pins ----------------
LiquidCrystal lcd(9, 8, 7, 6, 5, 4);

const int TEMP_SNS_PIN = A0;
const int XAXIS_SNS_PIN = A1;
const int GLU_SNS_PIN = A2;     // âœ… UPDATED: Glucose analog pin
const int HB_PIN = 2;
const int BUZZER_PIN = 12;      // ðŸ”” Buzzer pin

// ---------------- Wi-Fi & Cloud Config ----------------
#define WIFI_SSID "MitronF23@123"
#define WIFI_PASS "Mitrontech@123"
#define THINGSPEAK_API_KEY "GB9G3MH1AGX6BKIB"
#define THINGSPEAK_IP "api.thingspeak.com"
#define THINGSPEAK_PORT 80

// ---------------- Global Variables ----------------
volatile unsigned int buzzerCounter = 0;
volatile unsigned int buzzerOnCounter = 0;
volatile bool buzzerActive = false;
volatile bool buzzerEnable = false;
volatile unsigned int buzzerInterval = 0;

bool wifiConnected = false;
unsigned long lastWiFiRetry = 0;
bool GLUCOSE_LOW_FLG = false;
bool TEMP_Tenmec_Flg = false;
bool XAXIS_Tenmec_Flg = false;
bool UPDATE_DATA_WIFI = false;
bool FIVE_SEC_REF_FLAG = false;
bool LCD_CLR_FLG = false;
bool TOGGLE_FLG = false;

int TEMP_ADC_VAL = 0, TEMP_AVG = 0, TEMP = 25, Temp_Cnt = 0;
int XAXIS_ADC_VAL = 0, XAXIS_AVG = 0, XAXIS_Cnt = 0;
bool X_FLT_ACTIVE_FLG = false;
int HEART_BEAT_CNT = 0, HEART_BEAT_RATE = 0;
bool Heart_FLAG = false;
int AGE = 25;
int WIFI_CNT = 0, HB_SEC = 0, msec_cnt = 0, TEN_MCNT = 0;

int GLU_ADC_VAL = 0;     // âœ… Added: holds glucose ADC value

// ---------------- Function Prototypes ----------------
void initWiFi();
void sendToThingSpeak();
void TEMP_SENSOR();
void READ_GLU_SENSOR();
void READ_X_AXIS_SENSOR();
void Hear_Beat_Sensor();
void HB_MONITORING_SENSOR();
void LCD_INDICATIONS();
void timerIsr();

// ---------------- Setup ----------------
void setup() {
  lcd.begin(16, 2);
  Serial.begin(115200);

  pinMode(13, OUTPUT);
  pinMode(HB_PIN, INPUT);
  pinMode(BUZZER_PIN, OUTPUT);
  digitalWrite(BUZZER_PIN, LOW);

  lcd.setCursor(0, 0);
  lcd.print("MEDI SERVE SYSTEM");
  lcd.setCursor(0, 1);
  lcd.print("Initializing...");
  delay(1500);

  initWiFi();
}

// ---------------- Main Loop ----------------
void loop() {
  TEMP_SENSOR();
  HB_MONITORING_SENSOR();
  READ_X_AXIS_SENSOR();timerIsr();

  if (LCD_CLR_FLG) {
    lcd.clear();
    LCD_CLR_FLG = false;
  }

  LCD_INDICATIONS();

  if (UPDATE_DATA_WIFI && wifiConnected) {
    sendToThingSpeak();
    UPDATE_DATA_WIFI = false;
  }

  // Condition-based buzzer logic
  if ((HEART_BEAT_RATE > 20) && (HEART_BEAT_RATE < 60)) {
    buzzerEnable = true;
    buzzerInterval = 500;
  } else if (X_FLT_ACTIVE_FLG) {
    buzzerEnable = true;
    buzzerInterval = 2000;
  } else if (GLUCOSE_LOW_FLG) {
    buzzerEnable = true;
    buzzerInterval = 3000;
  } else if ((TEMP > 36) || (TEMP < 28)) {
    buzzerEnable = true;
    buzzerInterval = 5000;
  } else {
    buzzerEnable = false;
  }

  if (!wifiConnected && millis() - lastWiFiRetry > 30000UL) {
    initWiFi();
    lastWiFiRetry = millis();
  }
}

// ---------------- LCD Display ----------------
void LCD_INDICATIONS() {
  lcd.setCursor(0, 0);
  lcd.print("T:");
  lcd.print(TEMP);
  lcd.print((char)223);
  lcd.print("C ");

  lcd.setCursor(7, 0);
  lcd.print("HB:");
  lcd.print(HEART_BEAT_RATE);

  lcd.setCursor(0, 1);
  if (X_FLT_ACTIVE_FLG ) {
     if(TOGGLE_FLG){ lcd.print("M:ALERT "); }else{ lcd.print("         "); }
  } else if(X_FLT_ACTIVE_FLG==0) {
    lcd.print("M:NORM  ");
  }

  // âœ… Show Glucose ADC value
  lcd.setCursor(8, 1);
  lcd.print("G:");
  lcd.print(GLU_ADC_VAL);
  lcd.print("  "); // Clear trailing chars
}

// ---------------- Temperature Sensor ----------------
void TEMP_SENSOR() {
  if (TEMP_Tenmec_Flg) {
    int Temp_ADC = analogRead(TEMP_SNS_PIN);
    TEMP_ADC_VAL += Temp_ADC;
    Temp_Cnt++;
    TEMP_Tenmec_Flg = false;
  }

  if (Temp_Cnt >= 8) {
    TEMP_AVG = TEMP_ADC_VAL >> 3;
    TEMP_ADC_VAL = 0;
    Temp_Cnt = 0;

    if (TEMP_AVG > 610) TEMP = 25 + ((TEMP_AVG - 610) / 2);
    else TEMP = 25 - ((610 - TEMP_AVG) / 2);
  }
}

// ---------------- Glucose Sensor (Analog) ----------------
void READ_GLU_SENSOR() {
  static int GLU_ADC_SUM = 0, GLU_COUNT = 0;
  static int GLU_AVG = 0;

  int GLU_ADC = analogRead(GLU_SNS_PIN);
  GLU_ADC_SUM += GLU_ADC;
  GLU_COUNT++;

  if (GLU_COUNT >= 8) {
    GLU_AVG = GLU_ADC_SUM >> 3;
    GLU_ADC_SUM = 0;
    GLU_COUNT = 0;

    GLU_ADC_VAL = GLU_AVG;  // store for LCD display

    // âœ… Temporary logic â€“ threshold can be tuned later
    if (GLU_AVG > 960) {
      GLUCOSE_LOW_FLG = 1;
    } else {
      GLUCOSE_LOW_FLG = 0;
    }
  }
}

// ---------------- Motion Sensor ----------------
void READ_X_AXIS_SENSOR() {
  if (XAXIS_Tenmec_Flg) {
    int XAXIS_ADC = analogRead(XAXIS_SNS_PIN);
    XAXIS_ADC_VAL += XAXIS_ADC;
    XAXIS_Cnt++;
    XAXIS_Tenmec_Flg = false;
  }

  if (XAXIS_Cnt >= 8) {
    XAXIS_AVG = XAXIS_ADC_VAL >> 3;
    XAXIS_ADC_VAL = 0;
    XAXIS_Cnt = 0;
    X_FLT_ACTIVE_FLG = (XAXIS_AVG > 365 || XAXIS_AVG < 300);
  }
}

// ---------------- Heartbeat ----------------
void Hear_Beat_Sensor() {
  static int Heart_HI_Cnt = 0, Heart_LOW_Cnt = 0;
  if (digitalRead(HB_PIN)) {
    if (!Heart_FLAG && ++Heart_LOW_Cnt >= 1) {
      Heart_LOW_Cnt = 0;
      if (UPDATE_DATA_WIFI == 0) { HEART_BEAT_CNT++; }
      Heart_FLAG = true;
    }
  } else {
    if (++Heart_HI_Cnt >= 1) {
      Heart_HI_Cnt = 0;
      Heart_FLAG = false;
    }
  }
}

void HB_MONITORING_SENSOR() {
  if (FIVE_SEC_REF_FLAG) {
    HEART_BEAT_RATE = HEART_BEAT_CNT * 12;
    HEART_BEAT_CNT = 0;
    FIVE_SEC_REF_FLAG = false;
  }
}

// ---------------- Timer ISR ----------------
void timerIsr() {
  msec_cnt++;
  if (msec_cnt >= 25) {
    TOGGLE_FLG = !TOGGLE_FLG;
    LCD_CLR_FLG = true;
    digitalWrite(13, !digitalRead(13));

    if (!UPDATE_DATA_WIFI && ++WIFI_CNT >= 30) {
      UPDATE_DATA_WIFI = true;
      WIFI_CNT = 0;
    }

    if (!FIVE_SEC_REF_FLAG && ++HB_SEC >= 10) {
      FIVE_SEC_REF_FLAG = true;
      HB_SEC = 0;
    }
    msec_cnt = 0;
  }

  if (++TEN_MCNT >= 10) {
    READ_GLU_SENSOR();        // âœ… Analog glucose read
    TEMP_Tenmec_Flg = true;
    XAXIS_Tenmec_Flg = true;
    TEN_MCNT = 0;
    Hear_Beat_Sensor();
  }

  // Buzzer timing
  if (buzzerEnable) {
    buzzerCounter++;

    if (!buzzerActive && buzzerCounter >= buzzerInterval) {
      buzzerCounter = 0;
      buzzerActive = true;
      buzzerOnCounter = 0;
      digitalWrite(BUZZER_PIN, HIGH);
    }

    if (buzzerActive) {
      buzzerOnCounter++;
      if (buzzerOnCounter >= 50) {
        digitalWrite(BUZZER_PIN, LOW);
        buzzerActive = false;
      }
    }
  } else {
    digitalWrite(BUZZER_PIN, LOW);
    buzzerCounter = buzzerOnCounter = 0;
    buzzerActive = false;
  }
}

// ---------------- Wi-Fi Initialization ----------------
void initWiFi() {
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Init WiFi...");
  wifiConnected = false;

  Serial.println("AT");
  delay(1000);
  Serial.println("AT+CWMODE=1");
  delay(1000);
  Serial.println("AT+CIPMUX=1");
  delay(1000);

  bool connected = false;
  int retryCount = 0;

  while (!connected && retryCount < 2) {
    lcd.setCursor(0, 1);
    lcd.print("Connecting...  ");
    String cmd = "AT+CWJAP=\"" + String(WIFI_SSID) + "\",\"" + String(WIFI_PASS) + "\"";
    Serial.println(cmd);

    unsigned long startTime = millis();
    while (millis() - startTime < 10000) {
      if (Serial.find("WIFI CONNECTED")) {
        connected = true;
        break;
      }
      delay(200);
    }

    if (!connected) {
      retryCount++;
      lcd.setCursor(0, 1);
      lcd.print("Retry "); lcd.print(retryCount);
      delay(2000);
    }
  }

  if (connected) {
    Serial.println("AT+CIFSR");
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("WiFi Connected");
    wifiConnected = true;
    delay(1000);
  } else {
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("WiFi Failed!");
    lcd.setCursor(0, 1);
    lcd.print("Retry in 30s");
    wifiConnected = false;
    delay(2000);
  }
  lastWiFiRetry = millis();
}

// ---------------- ThingSpeak Upload ----------------
void sendToThingSpeak() {
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Updating Cloud");

  String cmd = "AT+CIPSTART=4,\"TCP\",\"" + String(THINGSPEAK_IP) + "\"," + String(THINGSPEAK_PORT);
  Serial.println(cmd);
  delay(2000);

  if (Serial.find("Error")) {
    Serial.println("AT+CIPSTART error");
    wifiConnected = false;
    return;
  }

  String getStr = "GET /update?api_key=" + String(THINGSPEAK_API_KEY);
  getStr += "&field1=" + String(TEMP);
  getStr += "&field2=" + String(HEART_BEAT_RATE);
  getStr += "&field3=" + String(GLUCOSE_LOW_FLG);  // âœ… send ADC instead of flag
  getStr += "&field4=" + String(X_FLT_ACTIVE_FLG ? 1 : 0);
  getStr += "\r\n\r\n";

  String sendCmd = "AT+CIPSEND=4," + String(getStr.length());
  Serial.println(sendCmd);
  delay(500);

  Serial.println(getStr);

  Serial.println("AT+CIPCLOSE=4");

  lcd.setCursor(0, 1);
  lcd.print("Cloud Updated ");
  delay(1000);
}